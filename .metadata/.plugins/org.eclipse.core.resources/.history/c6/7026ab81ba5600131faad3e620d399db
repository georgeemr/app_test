package com.example.fisba;

//import com.futronictech.R;

import java.io.File;
import java.io.FileOutputStream;

import com.example.fisba.Scanner;
import com.example.fisba.UsbDeviceDataExchangeImpl;
import com.example.fisba.FPScan;

import android.os.Bundle;
import android.os.Message;
import android.app.Activity;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.Canvas;
import android.graphics.ColorMatrix;
import android.graphics.ColorMatrixColorFilter;
import android.graphics.Paint;
import android.graphics.Bitmap.Config;
import android.view.Menu;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.CompoundButton;
import android.widget.ImageView;
import android.widget.TextView;
import android.widget.CompoundButton.OnCheckedChangeListener;
import android.os.Handler;

public class MainActivity extends Activity {
    /** Called when the activity is first created. */
	
	private static Button mButtonScan;
	private static Button mButtonStop;
	private Button mButtonSave;
	private static TextView mMessage;
	private static TextView mScannerInfo;
	private static ImageView mFingerImage;
	private CheckBox mCheckFrame;
	private CheckBox mCheckLFD;
	private CheckBox mCheckInvertImage;
	private CheckBox mCheckUsbHostMode;
	
    public static boolean mStop = false;
	public static boolean mFrame = true;
	public static boolean mLFD = false;
	public static boolean mInvertImage = false;
    
    public static final int MESSAGE_SHOW_MSG = 1;
    public static final int MESSAGE_SHOW_SCANNER_INFO = 2;
    public static final int MESSAGE_SHOW_IMAGE = 3;
    public static final int MESSAGE_ERROR = 4;
    public static final int MESSAGE_TRACE = 5;

    public static byte[] mImageFP = null;    
    public static int mImageWidth = 0;
    public static int mImageHeight = 0;
    private static Bitmap mBitmapFP = null;

    private FPScan mFPScan = null;   
    //
    public static boolean mUsbHostMode = true;

    // Intent request codes
    private static final int REQUEST_FILE_FORMAT = 1;
    private UsbDeviceDataExchangeImpl usb_host_ctx = null;

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        mFrame = true;
        mUsbHostMode = true;
    	mLFD = mInvertImage = false;    	
    	mButtonScan = (Button) findViewById(R.id.btnScan);
        mButtonStop = (Button) findViewById(R.id.btnStop);
        mButtonSave = (Button) findViewById(R.id.btnSave);

        usb_host_ctx = new UsbDeviceDataExchangeImpl(this, FPScan.mHandler);

        mButtonScan.setOnClickListener(new OnClickListener() {
            public void onClick(View v) {	        		
	        		if( mFPScan != null )
	        		{
	        			mStop = true;
	        			mFPScan.stop();
	        			
	        		}
	        		mStop = false;
	        		if(mUsbHostMode)
	        		{
		        		usb_host_ctx.CloseDevice();
		        		if(usb_host_ctx.OpenDevice(0, true))
		                {
		        			if( StartScan() )
			        		{
			        			mButtonScan.setEnabled(false);
			        	        mButtonSave.setEnabled(false);
			        	        mCheckUsbHostMode.setEnabled(false);
			        	        mButtonStop.setEnabled(true);
			        		}	
		                }
		            	else
		            	{
		            		if(!usb_host_ctx.IsPendingOpen())
		            		{
		            			mMessage.setText("Can not start scan operation.\nCan't open scanner device");
		            		}
		            	}    
	        		}
	        		else
	        		{
	        			if( StartScan() )
		        		{
		        			mButtonScan.setEnabled(false);
		        	        mButtonSave.setEnabled(false);
		        	        mCheckUsbHostMode.setEnabled(false);
		        	        mButtonStop.setEnabled(true);
		        		}	
	        		}
        		}
        });
        
        mButtonStop.setOnClickListener(new OnClickListener() {
            public void onClick(View v) {
	        		mStop = true;	       
	        		if( mFPScan != null )
	        		{
	        			mFPScan.stop();
	        			mFPScan = null;
       			
	        		}	        		
	        		mButtonScan.setEnabled(true);
	        		mButtonSave.setEnabled(true);
	        		mCheckUsbHostMode.setEnabled(true);
	        		mButtonStop.setEnabled(false);	        		
        		}
        });
        

        mCheckFrame.setOnCheckedChangeListener(new OnCheckedChangeListener() { 
			public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) { 
			if (buttonView.isChecked()) 
				mFrame = true;
			else 
			{
				mFrame = false;
				mCheckLFD.setChecked(false);
				mLFD = false;
			}
			} 
        });


        mCheckLFD.setOnCheckedChangeListener(new OnCheckedChangeListener() { 
			
			public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) { 
			if (buttonView.isChecked()) 
				mLFD = true;
			else 
				mLFD = false;
			} 
        });
        
        mCheckInvertImage.setOnCheckedChangeListener(new OnCheckedChangeListener() { 
			
			public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) { 
			if (buttonView.isChecked()) 
				mInvertImage = true;
			else 
				mInvertImage = false;
			} 
        });

        mCheckUsbHostMode.setOnCheckedChangeListener(new OnCheckedChangeListener() { 
			public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) { 
			if (buttonView.isChecked()) 
				mUsbHostMode = true;
			else 
				mUsbHostMode = false;
			} 
        });

    }
    
    @Override
	protected void onDestroy() {
		super.onDestroy();
		mStop = true;	       
		if( mFPScan != null )
		{
			mFPScan.stop();
			mFPScan = null;
		}
		usb_host_ctx.CloseDevice();
		usb_host_ctx.Destroy();
		usb_host_ctx = null;
    }

	private boolean StartScan()
    {
		mFPScan = new FPScan(usb_host_ctx, mHandler);
		mFPScan.start();		
		return true;
    }
    
}